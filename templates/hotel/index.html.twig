{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block title %}{{ 'hotel.list.title'|trans }}{% endblock %}

{% block page_title %}
    <div class="page-title">
        <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>{{ 'hotel.list.title'|trans }}</h3>
            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_dashboard') }}">{{ 'breadcrumb.home'|trans }}</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">{{ 'breadcrumb.hotels'|trans }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    <section class="section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ 'hotel.list.title'|trans }}</h4>
                <a href="{{ path('app_hotel_new') }}" class="btn btn-dark">
                    <i class="bi bi-plus-circle"></i> {{ 'hotel.actions.new'|trans }}
                </a>
            </div>
            <div class="card-body">
                <table class="table table-striped" id="hotels-table">
                    <thead>
                    <tr>
                        <th>{{ 'hotel.table.id'|trans }}</th>
                        <th>{{ 'hotel.table.name'|trans }}</th>
                        <th>{{ 'hotel.table.address'|trans }}</th>
                        <th>{{ 'hotel.table.contact_name'|trans }}</th>
                        <th>{{ 'hotel.table.contact_email'|trans }}</th>
                        <th>{{ 'hotel.table.contact_phone'|trans }}</th>
                        <th>{{ 'hotel.table.created_at'|trans }}</th>
                        <th>{{ 'hotel.table.actions'|trans }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for hotel in hotels %}
                        <tr>
                            <td>{{ hotel.id }}</td>
                            <td>
                                <i class="bi bi-building text-primary"></i>
                                <strong>{{ hotel.name }}</strong>
                            </td>
                            <td>{{ hotel.address ?? '-' }}</td>
                            <td>
                                {% if hotel.contactName %}
                                    <i class="bi bi-person-circle"></i> {{ hotel.contactName }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hotel.contactEmail %}
                                    <a href="mailto:{{ hotel.contactEmail }}" class="text-decoration-none">
                                        <i class="bi bi-envelope"></i> {{ hotel.contactEmail }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hotel.contactPhone %}
                                    <a href="tel:{{ hotel.contactPhone }}" class="text-decoration-none">
                                        <i class="bi bi-telephone"></i> {{ hotel.contactPhone }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ hotel.createdAt ? hotel.createdAt|date('d/m/Y H:i') : '' }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button"
                                            class="btn btn-sm btn-info"
                                            onclick="showHotelDetails({{ hotel.id }})"
                                            title="{{ 'hotel.actions.show'|trans }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a href="{{ path('app_hotel_edit', {'id': hotel.id}) }}"
                                       class="btn btn-sm btn-dark"
                                       title="{{ 'hotel.actions.edit'|trans }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-danger"
                                            onclick="confirmDelete({{ hotel.id }})"
                                            title="{{ 'hotel.actions.delete'|trans }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>

                                {# Formulaire de suppression caché #}
                                <form id="delete-form-{{ hotel.id }}"
                                      action="{{ path('app_hotel_delete', {'id': hotel.id}) }}"
                                      method="post"
                                      style="display: none;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ hotel.id) }}">
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">{{ 'hotel.list.no_hotels'|trans }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    {# Modal pour afficher les détails de l'hôtel #}
    <div class="modal fade" id="hotelDetailsModal" tabindex="-1" aria-labelledby="hotelDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hotelDetailsModalLabel">
                        <i class="bi bi-building"></i> <span id="hotelName"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {# Info Hôtel #}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong><i class="bi bi-geo-alt"></i> {{ 'hotel.table.address'|trans }}:</strong></p>
                                    <p id="hotelAddress" class="text-muted ms-4"></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong><i class="bi bi-person-circle"></i> {{ 'hotel.details.contact'|trans }}:</strong></p>
                                    <p id="hotelContact" class="text-muted ms-4"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Loading spinner #}
                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{{ 'hotel.details.loading'|trans }}</span>
                        </div>
                    </div>

                    {# Contenu des displays #}
                    <div id="displaysContent" style="display: none;"></div>

                    {# Message si aucun display #}
                    <div id="noDisplays" style="display: none;" class="alert alert-info">
                        <i class="bi bi-info-circle"></i> {{ 'hotel.details.no_displays'|trans }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'actions.close'|trans }}</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        initDataTable('#hotels-table');

    </script>
    <script>
        /**
         * Affiche le modal avec les détails de l'hôtel
         */
        function showHotelDetails(hotelId) {
            // Afficher le modal
            $('#hotelDetailsModal').modal('show');

            // Afficher le spinner
            $('#loadingSpinner').show();
            $('#displaysContent').hide();
            $('#noDisplays').hide();

            // Récupérer le préfixe de langue depuis l'URL actuelle (ex: /fr/)
            const currentPath = window.location.pathname;
            const localeMatch = currentPath.match(/^\/([a-z]{2})\//);
            const localePrefix = localeMatch ? `/${localeMatch[1]}` : '';

            // Charger les données via AJAX
            $.ajax({
                url: `${localePrefix}/hotel/${hotelId}/show`,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Remplir les infos de l'hôtel
                    $('#hotelName').text(data.name);
                    $('#hotelAddress').text(data.address || 'Non renseignée');

                    let contactHtml = data.contact.name || '-';
                    contactHtml += '<br>';
                    if (data.contact.email) {
                        contactHtml += `<a href="mailto:${data.contact.email}">${data.contact.email}</a><br>`;
                    }
                    if (data.contact.phone) {
                        contactHtml += `<a href="tel:${data.contact.phone}">${data.contact.phone}</a>`;
                    }
                    $('#hotelContact').html(contactHtml);

                    // Masquer le spinner
                    $('#loadingSpinner').hide();

                    // Afficher les displays
                    if (data.displays && data.displays.length > 0) {
                        $('#displaysContent').show();
                        renderDisplays(data.displays);
                    } else {
                        $('#noDisplays').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erreur:', error);
                    $('#loadingSpinner').hide();
                    alert('{{ 'hotel.details.error_loading'|trans }}');
                }
            });
        }

        /**
         * Affiche la liste des displays et leurs racks
         */
        function renderDisplays(displays) {
            let html = '';

            $.each(displays, function(index, display) {
                const totalRacks = display.racks.length;
                const fullRacks = display.racks.filter(r => r.status === 'full').length;

                html += `
            <div class="card mb-3 border-start border-4 border-primary">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-display"></i> ${display.name}
                        <span class="badge bg-secondary float-end">${totalRacks} rack(s)</span>
                    </h5>
                    ${display.location ? `<small class="text-muted"><i class="bi bi-pin-map"></i> ${display.location}</small>` : ''}
                </div>
                <div class="card-body">
        `;

                if (display.racks.length === 0) {
                    html += '<p class="text-muted mb-0"><i class="bi bi-inbox"></i> Aucun rack configuré</p>';
                } else {
                    html += '<div class="row">';

                    $.each(display.racks, function(rackIndex, rack) {
                        const statusConfig = getStatusConfig(rack.status);

                        html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-3 ${statusConfig.cardClass} shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="mb-0">
                                        <i class="bi bi-folder"></i> ${rack.name}
                                        <span class="badge ${statusConfig.badgeClass} ms-2">${statusConfig.label}</span>
                                    </h6>
                                    <span class="badge bg-light text-dark">Pos. ${rack.position}</span>
                                </div>

                                ${rack.product ? `
                                    <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                                        ${rack.product.image ?
                            `<img src="/uploads/products/${rack.product.image}"
                                                  alt="${rack.product.name}"
                                                  class="me-3 border border-2 border-secondary"
                                                  style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`
                            : '<i class="bi bi-box-seam fs-2 me-3 text-muted"></i>'}
                                        <div class="flex-grow-1">
                                            <strong class="d-block mb-1">${rack.product.name}</strong>
                                            <div>
                                                ${rack.product.language ? `<span class="badge bg-secondary me-1">${rack.product.language}</span>` : ''}
                                                ${rack.product.year_edition ? `<span class="badge bg-info">${rack.product.year_edition}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                ` : '<p class="text-muted mb-3"><i class="bi bi-exclamation-triangle"></i> Aucun produit assigné</p>'}

                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Stock: ${rack.current_quantity} / ${rack.required_quantity}</span>
                                        <span class="fw-bold">${rack.fill_percentage}%</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${statusConfig.progressClass}"
                                             role="progressbar"
                                             style="width: ${rack.fill_percentage}%"
                                             aria-valuenow="${rack.fill_percentage}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>

                                ${rack.required_quantity - rack.current_quantity > 0 ?
                            `<small class="text-danger">
                                        <i class="bi bi-exclamation-circle"></i>
                                        Manque: ${rack.required_quantity - rack.current_quantity} unité(s)
                                    </small>`
                            : '<small class="text-success"><i class="bi bi-check-circle"></i> Complet</small>'}
                            </div>
                        </div>
                    </div>
                `;
                    });

                    html += '</div>'; // end row
                }

                html += `
                </div>
            </div>
        `;
            });

            $('#displaysContent').html(html);
        }

        /**
         * Retourne la configuration visuelle selon le statut du rack
         */
        function getStatusConfig(status) {
            const configs = {
                'full': {
                    label: 'Complet',
                    badgeClass: 'bg-success',
                    cardClass: 'border-success',
                    progressClass: 'bg-success'
                },
                'medium': {
                    label: 'Moyen',
                    badgeClass: 'bg-warning',
                    cardClass: 'border-warning',
                    progressClass: 'bg-warning'
                },
                'low': {
                    label: 'Faible',
                    badgeClass: 'bg-danger',
                    cardClass: 'border-danger',
                    progressClass: 'bg-danger'
                },
                'empty': {
                    label: 'Vide',
                    badgeClass: 'bg-secondary',
                    cardClass: 'border-secondary',
                    progressClass: 'bg-secondary'
                }
            };

            return configs[status] || configs['empty'];
        }
    </script>
{% endblock %}
