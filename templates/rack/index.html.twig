{% extends 'base.html.twig' %}

{% block title %}{{ 'rack.list.title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block page_title %}
    <div class="page-title">
        <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>{{ 'rack.list.title'|trans }}</h3>
            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a
                                href="{{ path('app_dashboard') }}">{{ 'breadcrumb.home'|trans }}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ 'breadcrumb.racks'|trans }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    <section class="section">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ 'rack.title.subtitle'|trans }}</h4>
                <a href="{{ path('app_rack_new', {'_locale': app.request.locale}) }}" class="btn btn-dark">
                    <i class="bi bi-plus-circle"></i> {{ 'rack.actions.new'|trans }}
                </a>
            </div>
            <div class="card-body">
                <table class="table table-striped" id="rack-table">
                    <thead>
                    <tr>
                        <th>{{ 'rack.table.id'|trans }}</th>
                        <th>{{ 'rack.table.name'|trans }}</th>
                        <th>{{ 'rack.table.address'|trans }}</th>
                        <th>{{ 'rack.table.actions'|trans }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for rack in racks %}
                        <tr>
                            <td>{{ rack.id }}</td>
                            <td>{{ rack.name }}</td>
                            <td>{{ rack.address }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button"
                                            class="btn btn-outline-info btn-show-products"
                                            data-rack-id="{{ rack.id }}"
                                            data-bs-toggle="modal"
                                            data-bs-target="#products-modal"
                                            title="{{ 'rack.actions.show'|trans }}">
                                        <i class="bi bi-eye"></i>
                                    </button>


                                    <a href="{{ path('app_rack_edit', {'id': rack.id, '_locale': app.request.locale}) }}"
                                       class="btn btn-sm btn-dark"
                                       title="{{ 'rack.actions.edit'|trans }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-dark"
                                            onclick="confirmDelete({{ rack.id }})"
                                            title="{{ 'rack.actions.delete'|trans }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <form id="delete-form-{{ rack.id }}"
                                      action="{{ path('app_rack_delete', {'id': rack.id, '_locale': app.request.locale}) }}"
                                      method="post"
                                      style="display: none;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ rack.id) }}">
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">{{ 'rack.list.no_products'|trans }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    {# Modal pour afficher les produits #}
    <div class="modal fade" id="products-modal" tabindex="-1" aria-labelledby="productsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="productsModalLabel">
                        <i class="bi bi-box-seam"></i>
                        <span id="rack-name">{{ 'rack.products.title'|trans }}</span>
                    </h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="loading-spinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div id="products-content" style="display: none;">
                        <div class="mb-3">
                            <strong>{{ 'rack.address'|trans }}:</strong> <span id="rack-address"></span>
                        </div>

                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>{{ 'product.table.image'|trans }}</th>
                                <th>{{ 'product.table.name'|trans }}</th>
                                <th>{{ 'product.table.year'|trans }}</th>
                                <th>{{ 'product.table.language'|trans }}</th>
                                <th>{{ 'stock.table.quantity'|trans }}</th>
                                <th>{{ 'stock.table.note'|trans }}</th>
                            </tr>
                            </thead>
                            <tbody id="products-list">
                            {# Rempli dynamiquement via AJAX #}
                            </tbody>
                        </table>

                        <div id="no-products" class="alert alert-info" style="display: none;">
                            <i class="bi bi-info-circle"></i> {{ 'rack.products.empty'|trans }}
                        </div>
                    </div>
                </div>
{#                <div class="modal-footer">#}
{#                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">#}
{#                        <i class="bi bi-x-circle"></i> {{ 'form.button.cancel'|trans }}#}
{#                    </button>#}
{#                </div>#}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        initDataTable('#rack-table');
        $(document).ready(function () {
            // Gestionnaire pour le bouton "Afficher les produits"
            $('#rack-table').on('click', '.btn-show-products', function () {
                const rackId = $(this).data('rack-id');
                loadRackProducts(rackId);
            });
        });

        function loadRackProducts(rackId) {
            // Afficher le spinner
            $('#loading-spinner').show();
            $('#products-content').hide();

            // RequÃªte AJAX
            $.ajax({
                url: '{{ path('app_rack_products', {'id': '__ID__', '_locale': app.request.locale})|raw }}'.replace('__ID__', rackId),
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    // Masquer le spinner
                    $('#loading-spinner').hide();
                    $('#products-content').show();

                    // Remplir les informations du rack
                    $('#rack-name').text(data.rack.name);
                    $('#rack-address').text(data.rack.address || '-');

                    // Remplir la liste des produits
                    const $productsList = $('#products-list');
                    $productsList.empty();

                    if (data.products.length === 0) {
                        $('#no-products').show();
                        $productsList.closest('table').hide();
                    } else {
                        $('#no-products').hide();
                        $productsList.closest('table').show();

                        $.each(data.products, function (index, product) {
                            const imageHtml = product.image
                                ? `<img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;" class="rounded">`
                                : '<div class="bg-secondary rounded" style="width: 50px; height: 50px;"></div>';

                            const row = `
                                <tr>
                                    <td>${imageHtml}</td>
                                    <td>${product.name}</td>
                                    <td>${product.year_edition || '-'}</td>
                                    <td>${product.language || '-'}</td>
                                    <td><span class="badge bg-dark">${product.quantity}</span></td>
                                    <td>${product.note || '-'}</td>
                                </tr>
                            `;

                            $productsList.append(row);
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    $('#loading-spinner').hide();
                    alert('{{ 'error.loading_products'|trans }}');
                }
            });
        }
    </script>
{% endblock %}
